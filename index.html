<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Decadare — Master Notifications v6 (Clean)</title>
<style>
  :root{
    --red-dark:#8b0000; --red:#b22222; --red-soft:#a52a2a;
    --rose:#ffe0e6; --ink:#332; --bg:rgba(165,42,42,0.33); --card:#fff; --border:#f2d7dd;
  }
  *{box-sizing:border-box}
  html{ -webkit-text-size-adjust:100% }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);color:var(--ink);
    font-size:1.5rem;
    line-height:1.6;
  }
  header{
    background:var(--red-dark);color:#fff;text-align:center;
    padding:32px;
    border-radius:0 0 24px 24px;font-weight:700;
    font-size:2rem;
  }

  /* Top nav becomes a scrollable pill bar on phones */
  nav{
    position:sticky;top:0;z-index:10;display:flex;gap:12px;
    background:var(--red);padding:12px;
    overflow-x:auto;scroll-snap-type:x mandatory;
    -webkit-overflow-scrolling:touch;
  }
  nav::-webkit-scrollbar{display:none}
  nav button{
    flex:0 0 auto;border:0;border-radius:16px;padding:20px 22px;
    font-weight:700;background:var(--red-soft);color:#fff;cursor:pointer;
    font-size:1.3rem;scroll-snap-align:start;
  }
  nav button:hover{background:var(--red-dark)}
  #navAvatar {
    flex:0 0 auto;width:48px;height:48px;border-radius:50%;object-fit:cover;
    margin-left:4px;cursor:pointer;border:2px solid #fff;
  }

  main{padding:24px;max-width:960px;margin:0 auto;text-align:center}
  section{display:none}
  section.active{display:block;animation:fade .2s ease-in}
  @keyframes fade{from{opacity:.5;transform:translateY(4px)}to{opacity:1;transform:none}}
  h2,h3{color:var(--red-dark);margin:20px 0;text-align:center;font-size:1.8rem}

  .card{
    background:var(--card);border-radius:20px;box-shadow:0 3px 12px rgba(0,0,0,.15);
    padding:32px;margin:24px auto;text-align:center;max-width:880px;
    font-size:1.2rem;
  }
  textarea,.input,select{
    width:100%;border:1px solid #ccc;border-radius:16px;padding:16px;
    font-size:1.2rem;
  }
  .row{display:flex;justify-content:center;gap:16px;flex-wrap:wrap;align-items:center}
  .chip{
    display:inline-block;background:var(--rose);color:var(--red-dark);
    border-radius:999px;padding:8px 16px;font-weight:700;font-size:1.1rem;
  }
  .btn{
    border:0;border-radius:16px;padding:16px 20px;background:var(--red);
    color:#fff;font-weight:700;cursor:pointer;font-size:1.2rem;
  }
  .btn:hover{background:var(--red-dark)}
  .btn-soft{background:var(--red-soft)}
  .dropdown{
    border-radius:20px;background:#fff;box-shadow:0 3px 10px rgba(0,0,0,.12);
    overflow:hidden;margin:12px auto;max-width:860px;font-size:1.2rem;
  }
  .dropdown-header{
    padding:16px;background:var(--red);color:#fff;font-weight:700;cursor:pointer;
    text-align:center;font-size:1.3rem;
  }
  .dropdown-content{
    display:none;max-height:320px;overflow-y:auto;padding:12px
  }
  .dropdown.expanded .dropdown-content{display:block}
  .option{
    display:flex;justify-content:center;align-items:center;
    border:1px solid var(--border);background:#fff7f8;
    border-radius:16px;padding:12px;margin:8px 0;gap:16px;font-size:1.2rem;
  }
  .option button{
    border:0;border-radius:12px;padding:10px 14px;background:var(--red);color:#fff;cursor:pointer;
    font-size:1.1rem;
  }
  .option button:hover{background:var(--red-dark)}
  .timer{font-weight:800;color:var(--red-dark);font-size:1.3rem}
  .btn[disabled]{opacity:.5;pointer-events:none}

  /* Modal base */
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;
    align-items:center;justify-content:center;z-index:1000;padding:16px;
  }
  .modal-backdrop.show{display:flex}
  .modal-card{
    max-width:min(640px,92vw);max-height:90vh;overflow:auto;position:relative;font-size:1.2rem
  }
  .close-x{position:absolute;top:12px;right:12px;font-size:1.5rem}

  #account {
    display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;
    padding:32px;font-size:1.2rem;
  }
  #accountInfo {display:flex;flex-direction:column;align-items:center;gap:16px;}
  #accountInfo input,#accountInfo button {width:80%;max-width:340px;font-size:1.2rem;padding:12px;}
  #avatarPreview {
    width:140px;height:140px;border-radius:50%;object-fit:cover;border:3px solid #8b0000;
  }
  .btn-change-avatar {
    display:inline-block;margin-top:12px;padding:10px 16px;background:#8b0000;color:#fff;
    border-radius:8px;cursor:pointer;font-size:1.1rem;
  }
  .btn-change-avatar:hover {background:#a00000;}

  /* Mobile Optimizations */
  @media (max-width: 768px) {
    header { font-size:1.5rem; padding:20px }
    nav { gap:8px; padding:10px }
    nav button { font-size:1rem; padding:10px 14px; min-width:88px }
    #navAvatar { width:36px;height:36px;margin-left:6px }
    main { padding:12px }
    .card { padding:16px; margin:12px auto; max-width:100%; font-size:1rem }
    textarea,.input,select { font-size:1rem; padding:10px }
    .chip { font-size:.95rem; padding:6px 12px }
    .btn { font-size:1rem; padding:10px 14px }
    .dropdown-content { max-height:60vh }
    .modal-card { font-size:1rem; padding:16px }
  }
  @media (max-width: 480px) {
    nav button { min-width:76px }
    .dropdown-content { max-height:50vh }
  }
</style>
</head>

<body>
<header>Decadare — Master Notifications v6</header>
<nav>
  <button id="accountBtn" onclick="navTo('account')">Account</button>
  <img id="navAvatar" src="" alt="Avatar" style="display:none;">
  <button onclick="navTo('home')">Home</button>
  <button onclick="navTo('create')">Create</button>
  <button onclick="navTo('active')">Active</button>
  <button onclick="navTo('wins')">Wins</button>
  <button onclick="navTo('proof')">Proof</button>
  <button onclick="navTo('history')">History</button>
</nav>

<main>
  <section id="home" class="active">
    <div class="card">
      <h2>Welcome</h2>
      <p>Centered dark romantic build with full options, Prize or Stakes and Company Prizes, series best of 3 or best of 7, timer presets, notifications, and modals.</p>
      <div class="row">
        <button class="btn" onclick="navTo('create')">Start a Challenge</button>
        <button class="btn btn-soft" onclick="testWin()">Test Win Notification</button>
        <button class="btn btn-soft" onclick="testReceived()">Test Received Notification</button>
        <button class="btn" onclick="toggleRole()">Switch Role for Testing</button>
      </div>
      <p class="chip">Current Role: <span id="roleChip">Initiator</span></p>
    </div>
  </section>

  <section id="create">
    <div class="card">
      <h2>Create Challenge</h2>
      <label>Description Decency or Decadence</label>
      <textarea id="challengeDescription" placeholder="Selected challenge will appear here..."></textarea>
      <div style="margin-top:8px;text-align:left">
        <label style="display:flex;align-items:center;gap:6px;font-weight:600;color:#5a2a2a;">
          <input type="checkbox" id="requiresResponse" /> Response after acceptance required
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <label>Timer 
          <select class="input" id="challengeTimer">
            <option value="30">30 seconds</option>
            <option value="60">1 minute</option>
            <option value="300">5 minutes</option>
            <option value="600">10 minutes</option>
            <option value="1200">20 minutes</option>
            <option value="1800">30 minutes</option>
            <option value="3600">1 hour</option>
            <option value="7200">2 hours</option>
            <option value="86400">1 day</option>
          </select>
        </label>
        <label>Rules optional <input class="input" type="text" id="challengeRules" placeholder="Any special rules..." /></label>
        <label>Series</label>
        <select class="input" id="seriesSelect">
          <option value="">Single Game</option>
          <option value="bo3">BEST OF 3 two of three</option>
          <option value="bo7">BEST OF 7 four of seven</option>
        </select>
      </div>
    </div>

    <div class="card">
      <h3>Decency</h3>
      <div class="dropdown"><div class="dropdown-header" onclick="toggleDD(this)">Daily Habits</div><div class="dropdown-content" id="Daily Habits"></div></div>
      <div class="dropdown"><div class="dropdown-header" onclick="toggleDD(this)">Lifestyle Fun</div><div class="dropdown-content" id="Lifestyle Fun"></div></div>
    </div>

    <div class="card">
      <h3>Decadence</h3>
      <div class="dropdown"><div class="dropdown-header" onclick="toggleDD(this)">Playful Intimacy</div><div class="dropdown-content" id="Playful Intimacy"></div></div>
      <div class="dropdown"><div class="dropdown-header" onclick="toggleDD(this)">Romance Boosters</div><div class="dropdown-content" id="Romance Boosters"></div></div>
    </div>

    <div class="card">
      <h3>Rewards</h3>
      <label>Prize or Stakes manual</label>
      <input class="input" type="text" id="prizeStakes" placeholder="Select or type prize or stakes" />
      <div class="dropdown"><div class="dropdown-header" onclick="toggleDD(this)">Stakes</div><div class="dropdown-content" id="stakesList"></div></div>
      <div class="dropdown"><div class="dropdown-header" onclick="toggleDD(this)">Prizes</div><div class="dropdown-content" id="prizesList"></div></div>
      <div class="dropdown"><div class="dropdown-header" onclick="toggleDD(this)">Company Prizes</div><div class="dropdown-content" id="companyPrizes"></div></div>
    </div>

    <div class="card"><button class="btn" onclick="confirmChallenge()">Confirm Challenge</button></div>
  </section>

  <section id="confirm">
    <div class="card">
      <h2>Challenge Details</h2>
      <p id="detailDesc"></p>
      <p>Prize or Stakes <span id="detailStake"></span></p>
      <p>Rules <span id="detailRules"></span></p>
      <p>Series <span id="detailSeries"></span></p>
      <p>Response Required <span id="detailRequiresResponse"></span></p>
      <p>Time preset <span class="timer" id="detailTimer"></span></p>
      <div class="row">
        <button class="btn" onclick="sendChallenge()">Send to Opponent</button>
        <button class="btn btn-soft" onclick="navTo('create')">Back</button>
      </div>
    </div>
  </section>

  <section id="active">
    <h2>Active Challenges</h2>
    <div id="activeList"></div>
  </section>

  <section id="wins">
    <h2>My Wins</h2>
    <div id="winsList"></div>
  </section>

  <section id="proof">
    <h2>My Proof Losses</h2>
    <div id="proofList"></div>
  </section>

  <section id="history">
    <h2>History</h2>
    <div id="historyList"></div>
  </section>

  <section id="account" style="display:none;">
    <h2>Account</h2>
    <div id="accountInfo">
      <img id="avatarPreview" src="" alt="Avatar">
      <label for="avatarUpload" class="btn-change-avatar">Change Avatar</label>
      <input type="file" id="avatarUpload" accept="image/*" style="display:none;">
      <p><input type="text" id="username" placeholder="Name" autocomplete="off" name="username"></p>
      <p><input type="email" id="useremail" placeholder="Email" autocomplete="email" name="email"></p>
      <button id="saveBtn" onclick="saveAccount()">Save</button>
      <button onclick="logout()">Logout</button>
    </div>
  </section>
</main>

<!-- Modals -->
<div id="winModal" class="modal-backdrop">
  <div class="card modal-card">
    <button class="btn btn-soft close-x" onclick="closeWinModal(event)">×</button>
    <h2>Challenge Won</h2>
    <p id="winDetails"></p>
    <h3 style="color:var(--red-dark)">Prize or Stake</h3>
    <p id="winPrize"></p>
  </div>
</div>

<div id="receiveModal" class="modal-backdrop">
  <div class="card modal-card">
    <button class="btn btn-soft close-x" onclick="closeReceiveModal(event)">×</button>
    <h2>New Challenge Received</h2>
    <p id="receiveDesc"></p>
    <p><strong>Prize or Stakes</strong> <span id="receivePrize"></span></p>
    <p><strong>Rules</strong> <span id="receiveRules"></span></p>
    <p><strong>Series</strong> <span id="receiveSeries"></span></p>
    <div class="row">
      <button class="btn" onclick="acceptChallenge()">Accept</button>
      <button class="btn btn-soft" onclick="declineChallenge()">Decline</button>
    </div>
  </div>
</div>

<div id="disclaimerModal" class="modal-backdrop">
  <div class="card modal-card">
    <button class="btn btn-soft close-x" onclick="closeDisclaimer(event)">×</button>
    <h2>Confirm Winner</h2>
    <p id="disclaimerText"></p>
    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="confirmDeclare()">Yes Confirm</button>
      <button class="btn btn-soft" onclick="closeDisclaimer(event)">Cancel</button>
    </div>
  </div>
</div>

<div id="winsDetailModal" class="modal-backdrop">
  <div class="card modal-card">
    <button class="btn btn-soft close-x" onclick="closeWinsDetail(event)">×</button>
    <h2>Win Details</h2>
    <p id="winsDetailDesc"></p>
    <p><strong>Prize or Stakes</strong> <span id="winsDetailStake"></span></p>
    <p><strong>Rules</strong> <span id="winsDetailRules"></span></p>
    <p><strong>Series</strong> <span id="winsDetailSeries"></span></p>
    <p><strong>Final Score</strong> <span id="winsDetailScore"></span></p>
  </div>
</div>

<div id="proofDetailModal" class="modal-backdrop">
  <div class="card modal-card">
    <button class="btn btn-soft close-x" onclick="closeProofDetail(event)">×</button>
    <h2>Loss Details</h2>
    <p id="proofDetailDesc"></p>
    <p><strong>Prize or Stakes</strong> <span id="proofDetailStake"></span></p>
    <p><strong>Rules</strong> <span id="proofDetailRules"></span></p>
    <p><strong>Series</strong> <span id="proofDetailSeries"></span></p>
    <p><strong>Final Score</strong> <span id="proofDetailScore"></span></p>
  </div>
</div>

<div id="historyDetailModal" class="modal-backdrop">
  <div class="card modal-card">
    <button class="btn btn-soft close-x" onclick="closeHistoryDetail(event)">×</button>
    <h2>History Details</h2>
    <p id="historyDetailDesc"></p>
    <p><strong>Prize or Stakes</strong> <span id="historyDetailStake"></span></p>
    <p><strong>Rules</strong> <span id="historyDetailRules"></span></p>
    <p><strong>Series</strong> <span id="historyDetailSeries"></span></p>
    <p><strong>Final Score</strong> <span id="historyDetailScore"></span></p>
    <p id="historyExtra"></p>
  </div>
</div>

<script>
let activeChallenges = JSON.parse(localStorage.getItem("activeChallenges") || "[]");
let historyChallenges = JSON.parse(localStorage.getItem("historyChallenges") || "[]");
let wins = JSON.parse(localStorage.getItem("wins") || "[]");
let proofs = JSON.parse(localStorage.getItem("proofs") || "[]");
let isInitiator = true;

const descriptionBox = document.getElementById("challengeDescription");
const rulesBox = document.getElementById("challengeRules");
const roleChip = document.getElementById("roleChip");

document.addEventListener("DOMContentLoaded", ()=>{
  if ("Notification" in window) {
    try{ Notification.requestPermission(); }catch(e){}
  }
  loadUserFromStorage();
  wireAvatarUpload();
  updateNavAvatar();
});

function navTo(id){
  document.querySelectorAll("main section").forEach(sec=>{ sec.style.display="none" });
  const target=document.getElementById(id);
  if(target){ target.style.display="block" }
}
function toggleDD(h){ h.parentElement.classList.toggle("expanded") }
function toggleRole(){ isInitiator = !isInitiator; roleChip.textContent = isInitiator ? "Initiator" : "Opponent"; renderAll() }

/* Option builder */
function addOption(containerId, text, targetId){
  const container = document.getElementById(containerId);
  if(!container) return;
  const row = document.createElement("div");
  row.className="option";
  row.innerHTML = "<span>"+text+"</span>";
  const btn = document.createElement("button");
  btn.textContent = "Use";
  btn.onclick = () => {
    const target = document.getElementById(targetId);
    if(target && (target.tagName.toLowerCase()==="textarea" || target.tagName.toLowerCase()==="input")){
      target.value = text;
    }
    const dd = container.closest(".dropdown");
    if(dd) dd.classList.remove("expanded");
  };
  row.appendChild(btn);
  container.appendChild(row);
}

/* Lists */
const dailyHabits = ["Drink 8 glasses of water today","Go for a 20-minute walk together","Cook a healthy dinner at home","Journal one gratitude each","Meditate for 10 minutes together","Swap phone-free time for 1 hour","Stretch before bed","Share your favorite song of the day","Compliment each other 3 times","Take turns giving each other a short massage","Read aloud 2 pages from a book","Share a funny memory at dinner","Do 20 squats or pushups together","Plan tomorrow’s meals together","Share one new thing you learned today","Make the bed together","Drink tea instead of coffee for one round","Pack lunch for each other","Write a sticky note of encouragement","Do a 5-minute breathing exercise together","Declutter one drawer or shelf together","Dance to one full song","Share a 2-minute eye contact silence","Call or text one family member together","Give each other a thank you at bedtime"];
const lifestyleFun = ["Watch a new movie tonight","Play a board game or card game","Try a new recipe","Explore a new café or restaurant","Take a selfie adventure outdoors","Plan your dream vacation together","Sing karaoke at home","Do a random act of kindness as a pair","Try drawing portraits of each other","Bake cookies or cake together","Learn a dance on YouTube","Go stargazing outside","Write a short poem for each other","Try a yes day for small requests","Go on a late-night drive","Build a pillow fort","Try a puzzle or Lego set","Visit a local landmark","Do a themed dinner","Play a trivia quiz against each other","Listen to a podcast together","Watch sunrise or sunset","Share childhood photos and stories","Write a silly short story together","Make a playlist for each other"];
const playfulIntimacy = ["Kiss for 30 seconds without stopping","Hold hands for an entire walk","Whisper three fantasies into each other’s ear","Write each other a flirty note","Share a slow dance in the living room","Give a one-minute shoulder rub","Touch each other without speaking for 2 minutes","Send a playful text while in the same room","Blindfold partner and guide them around the room","Try a new cuddle position","Roleplay as strangers meeting for the first time","Take a shower together","Tell each other a secret desire","Draw a heart on your partner’s hand","Exchange top three turn-ons","Do a lap-sit challenge for one song","Try feeding each other dessert","Tickle each other for 1 minute","Share favorite body compliment","Dance close with eyes closed","Recreate your first kiss","Create a secret couple handshake","Share your most attractive outfit tonight","Practice kissing in different ways","Play a truth or dare mini round"];
const romanceBoosters = ["Light candles during dinner","Write each other a love letter","Plan a surprise date night","Recreate your first date meal","Say I love you five times today","Share why you first fell for each other","Give partner your jacket or sweater","Watch wedding or engagement videos together","Plan a weekend getaway idea","Leave a hidden love note to find later","Play five compliments back and forth","Hold hands under the table for 10 minutes","Cook breakfast in bed","Write names with a heart on foggy mirror","Share a romantic movie scene reenactment","Play favorite couple’s song and dance","Take a photo together in a new place","Share your dream anniversary trip","Make a bucket list of 10 couple goals","Tell each other one thing you are proud of","Give each other foot rubs","Take turns saying You are mine playfully","Plan a surprise weekend breakfast","Look into each other’s eyes silently for 3 minutes","Share one wish for the relationship"];
const stakes = ["Do the dishes","Cook dinner","Pay for dessert","Foot massage 10 minutes","Winner chooses next movie","Loser plans tomorrow’s breakfast","Clean the living room","Loser sings a song of winner’s choice","Winner picks date night location","Loser makes bed for a week","Winner controls TV remote","Loser buys snacks","Take trash out for 3 days","Winner gets car music control","Loser compliments winner 5 times","Winner gets a coffee bought","Loser does one chore card chosen at random","Winner picks bedtime story","Loser must write a haiku for winner","Winner gets dessert first","Loser vacuums tomorrow","Winner gets breakfast served","Loser gives winner 5 back pats","Winner controls playlist","Loser sets up candles tonight"];
const prizes = ["Candlelit dinner","A box of chocolates","A handwritten love poem","Surprise breakfast in bed","A flower bouquet","A massage coupon","Romantic playlist made","A framed photo of both","A love letter","Bubble bath prepared","Picnic setup","Homemade dessert","Breakfast cooked by partner","Evening of no chores","Small wrapped gift","Spa night at home","Personalized coupon book","Favorite drink delivered","Winner gets a serenade","A surprise coffee date","Outfit chosen by partner","Favorite meal prepared","Scented candle gift","A kiss marathon challenge","Romantic note hidden somewhere"];
const companyPrizes = ["Coffee Date from Local Café","Spa Voucher by BlissCo","Dinner for Two by Bistro Partners","Movie Night Tickets by CineWorld","Dessert Box by SweetTreats","Flower Delivery by Bloom Alley","Wine Tasting Pass by Vino Club","Brunch for Two by SunnySide","Picnic Kit by Outdoor Co","Fitness Class Pass by FitTogether"];

dailyHabits.forEach(t=>addOption("Daily Habits",t,"challengeDescription"));
lifestyleFun.forEach(t=>addOption("Lifestyle Fun",t,"challengeDescription"));
playfulIntimacy.forEach(t=>addOption("Playful Intimacy",t,"challengeDescription"));
romanceBoosters.forEach(t=>addOption("Romance Boosters",t,"challengeDescription"));
stakes.forEach(t=>addOption("stakesList",t,"prizeStakes"));
prizes.forEach(t=>addOption("prizesList",t,"prizeStakes"));
companyPrizes.forEach(t=>addOption("companyPrizes",t,"prizeStakes"));

/* Confirm view */
let pendingChallenge = null;

function confirmChallenge(){
  const desc = (descriptionBox.value||"").trim();
  const prizeStakes = (document.getElementById("prizeStakes").value||"").trim();
  const series = document.getElementById("seriesSelect").value;
  const secs = parseInt(document.getElementById("challengeTimer").value)||60;
  const rules = (rulesBox.value||"").trim();
  const requiresResponse = !!document.getElementById("requiresResponse").checked;

  if(!desc){ alert("Please select or type a challenge."); return }

  pendingChallenge = {
    id: Date.now()+"-"+Math.random().toString(36).slice(2),
    description: desc,
    stake: prizeStakes || "None",
    rules: rules || "",
    series: series,
    duration: secs,
    requiresResponse,
    score: {a:0,b:0},
    initiator: "Initiator",
    opponent: "Opponent",
    timerStarted:false
  };

  document.getElementById("detailDesc").textContent = desc;
  document.getElementById("detailStake").textContent = pendingChallenge.stake;
  document.getElementById("detailRules").textContent = pendingChallenge.rules || "—";
  document.getElementById("detailSeries").textContent = series===""?"Single":(series==="bo3"?"BEST OF 3":"BEST OF 7");
  document.getElementById("detailRequiresResponse").textContent = requiresResponse ? "Yes" : "No";
  document.getElementById("detailTimer").textContent = secs + "s";
  navTo("confirm");
}

function sendChallenge(){
  if(!pendingChallenge) return;
  // Add to Active as pending acceptance
  activeChallenges.push(Object.assign({}, pendingChallenge));
  persist();
  // Notify opponent and pass the same id object
  notifyReceived(Object.assign({}, pendingChallenge));
  pendingChallenge=null;
  renderAll();
  navTo("active");
}

/* Renders */
let activeTimers={};

function renderAll(){
  renderActive();
  renderWins();
  renderProof();
  renderHistory();
}

function renderWins(){
  const wrap=document.getElementById("winsList");wrap.innerHTML="";
  wins.forEach((w)=>{
    const div=document.createElement("div");div.className="card";
    div.innerHTML=`<p><strong>${w.description}</strong></p><p>WIN</p>`;
    div.onclick=()=>showWinsDetail(w);
    wrap.appendChild(div);
  });
}

function renderProof(){
  const wrap=document.getElementById("proofList");wrap.innerHTML="";
  proofs.forEach((p)=>{
    const div=document.createElement("div");div.className="card";
    div.innerHTML=`<p><strong>${p.description}</strong></p><p>LOSS</p>`;
    div.onclick=()=>showProofDetail(p);
    wrap.appendChild(div);
  });
}

function renderHistory(){
  const wrap=document.getElementById("historyList");wrap.innerHTML="";
  historyChallenges.forEach((h)=>{
    const div=document.createElement("div");div.className="card";
    let label = h.declined ? "DECLINED" : (h.expired ? "EXPIRED" : "DONE");
    div.innerHTML=`<p><strong>${h.description}</strong></p><p>${label}</p>`;
    div.onclick=()=>showHistoryDetail(h);
    wrap.appendChild(div);
  });
}

function renderActive(){
  const wrap=document.getElementById("activeList");wrap.innerHTML="";
  Object.values(activeTimers).forEach(id=>clearInterval(id));activeTimers={};
  activeChallenges.forEach((c,i)=>{
    const div=document.createElement("div");div.className="card";
    const needed = c.series==="bo3"?2:(c.series==="bo7"?4:null);
    const scoreA=c.score?.a||0;
    const scoreB=c.score?.b||0;
    const winnerSide = needed ? (scoreA>=needed?'a':(scoreB>=needed?'b':null)) : null;
    const saveDisabled = needed ? (!winnerSide ? "disabled" : "") : "";

    let controls="";
    if(!isInitiator){
      controls = "<p class='chip'>Read only Opponent View</p>";
    } else if(!needed){
      controls=`<div class="row" style="margin-top:8px">
        <button class="btn" onclick="openDisclaimer(${i},'a')">Declare Winner Initiator</button>
        <button class="btn btn-soft" onclick="openDisclaimer(${i},'b')">Declare Winner Opponent</button>
      </div>`;
    } else {
      controls=`<div class="row" style="margin-top:8px">
        <button class="btn" ${saveDisabled} onclick="if(!this.hasAttribute('disabled')) openDisclaimer(${i},'${winnerSide||''}')">Save Result</button>
      </div>`;
    }

    const seriesLabel = c.series===""?"Single":(c.series==="bo3"?"BEST OF 3":"BEST OF 7");
    const timeFragment = c.deadline ? `<span class="timer" id="t-${i}"></span>` : `<span class="chip">Awaiting acceptance</span>`;

    div.innerHTML=`
      <p><strong>${c.description}</strong></p>
      <p>Prize or Stakes ${c.stake||"—"} | Rules ${c.rules||"—"}</p>
      <p>Series ${seriesLabel} | Score ${(c.score?c.score.a:0)} - ${(c.score?c.score.b:0)}</p>
      ${c.requiresResponse ? `<p><strong>Response</strong> ${c.response||"Pending"}</p>` : ""}
      <p>Time left ${timeFragment}</p>
      <div class="row">
        <span class="chip">Initiator <span id="sa-${i}">${c.score?.a||0}</span></span>
        ${isInitiator?`<button class="btn" onclick="bump(${i},'a',1)">+ Initiator</button>
        <button class="btn btn-soft" onclick="bump(${i},'a',-1)">– Initiator</button>`:""}
        <span class="chip">Opponent <span id="sb-${i}">${c.score?.b||0}</span></span>
        ${isInitiator?`<button class="btn" onclick="bump(${i},'b',1)">+ Opponent</button>
        <button class="btn btn-soft" onclick="bump(${i},'b',-1)">– Opponent</button>`:""}
      </div>
      ${controls}
    `;
    wrap.appendChild(div);

    if(c.deadline){
      const elId="t-"+i;
      const tick=()=>{
        const el=document.getElementById(elId);
        if(!el){clearInterval(activeTimers[elId]);return}
        const rem=Math.max(0,Math.floor((c.deadline-Date.now())/1000));
        el.textContent=rem+"s";
        if(rem<=0){
          clearInterval(activeTimers[elId]);
          if(!c.expired){ c.expired = true; persist() }
          el.textContent = "Expired";
        }
      };
      tick();
      activeTimers[elId]=setInterval(tick,1000);
    }
  });
}

/* Score and winner */
function bump(index,side,delta){
  if(!isInitiator) return;
  const c=activeChallenges[index];if(!c.score)c.score={a:0,b:0};
  c.score[side]=Math.max(0,(c.score[side]||0)+delta);
  const spanId = side==='a'?'sa-'+index:'sb-'+index;
  const el = document.getElementById(spanId);
  if(el) el.textContent=c.score[side];
  persist();
  renderActive();
}

/* Disclaimer flow */
let declareIdx = null;
let declareSide = null;
function openDisclaimer(index, winnerSide){
  declareIdx = index; declareSide = winnerSide;
  const user = (winnerSide==='a'?'Initiator':'Opponent');
  document.getElementById("disclaimerText").textContent = "This will close the challenge and it is irreversible. Confirm "+user+" as winner";
  document.getElementById("disclaimerModal").classList.add("show");
}
function closeDisclaimer(e){ if(e) e.stopPropagation(); document.getElementById("disclaimerModal").classList.remove("show") }
function confirmDeclare(){
  if(declareIdx===null || !declareSide){ closeDisclaimer(); return }
  finalizeDeclare(declareIdx, declareSide);
  closeDisclaimer();
}
function finalizeDeclare(index,side){
  const c=activeChallenges.splice(index,1)[0];
  if(side==='a'){ wins.push(c); notifyWin(c) } else { proofs.push(c) }
  historyChallenges.push(c);
  persist();
  renderAll();
}

/* Detail modals without duplicate lines */
function showWinsDetail(win){
  document.getElementById("winsDetailDesc").innerText = win.description;
  document.getElementById("winsDetailStake").innerText = win.stake||"—";
  document.getElementById("winsDetailRules").innerText = win.rules||"—";
  document.getElementById("winsDetailSeries").innerText = win.series===""?"Single":(win.series==="bo3"?"BEST OF 3":"BEST OF 7");
  document.getElementById("winsDetailScore").innerText = (win.score?win.score.a:0) + " - " + (win.score?win.score.b:0);
  const card = document.getElementById("winsDetailModal").querySelector(".card");
  const prev = card.querySelector(".extra-response"); if(prev) prev.remove();
  card.insertAdjacentHTML("beforeend","<p class='extra-response'><strong>Response</strong> "+(win.response||"—")+"</p>");
  document.getElementById("winsDetailModal").classList.add("show");
}
function closeWinsDetail(e){ if(e) e.stopPropagation(); document.getElementById("winsDetailModal").classList.remove("show") }

function showProofDetail(p){
  document.getElementById("proofDetailDesc").innerText = p.description;
  document.getElementById("proofDetailStake").innerText = p.stake||"—";
  document.getElementById("proofDetailRules").innerText = p.rules||"—";
  document.getElementById("proofDetailSeries").innerText = p.series===""?"Single":(p.series==="bo3"?"BEST OF 3":"BEST OF 7");
  document.getElementById("proofDetailScore").innerText = (p.score?p.score.a:0) + " - " + (p.score?p.score.b:0);
  const card = document.getElementById("proofDetailModal").querySelector(".card");
  const prev = card.querySelector(".extra-response"); if(prev) prev.remove();
  card.insertAdjacentHTML("beforeend","<p class='extra-response'><strong>Response</strong> "+(p.response||"—")+"</p>");
  document.getElementById("proofDetailModal").classList.add("show");
}
function closeProofDetail(e){ if(e) e.stopPropagation(); document.getElementById("proofDetailModal").classList.remove("show") }

function showHistoryDetail(h){
  document.getElementById("historyDetailDesc").innerText = h.description;
  document.getElementById("historyDetailStake").innerText = h.stake||"—";
  document.getElementById("historyDetailRules").innerText = h.rules||"—";
  document.getElementById("historyDetailSeries").innerText = h.series===""?"Single":(h.series==="bo3"?"BEST OF 3":"BEST OF 7");
  document.getElementById("historyDetailScore").innerText = (h.score?h.score.a:0) + " - " + (h.score?h.score.b:0);
  document.getElementById("historyExtra").innerText = h.declined ? "(Declined)" : (h.expired ? "(Expired)" : "");
  const card = document.getElementById("historyDetailModal").querySelector(".card");
  const prev = card.querySelector(".extra-response"); if(prev) prev.remove();
  card.insertAdjacentHTML("beforeend","<p class='extra-response'><strong>Response</strong> "+(h.response||"—")+"</p>");
  document.getElementById("historyDetailModal").classList.add("show");
}
function closeHistoryDetail(e){ if(e) e.stopPropagation(); document.getElementById("historyDetailModal").classList.remove("show") }

/* Notifications */
function notifyWin(win){
  const body = "Prize "+(win.stake||"—");
  if("Notification" in window && Notification.permission==="granted"){
    try{ new Notification("You Won",{ body }) }catch(e){ alert("You Won "+body) }
  } else { alert("You Won "+body) }
}
let pendingReceived = null;
function notifyReceived(challenge){
  if("Notification" in window && Notification.permission==="granted"){
    try{
      const n = new Notification("New Challenge",{ body: challenge.initiator+" challenged you: "+challenge.description });
      n.onclick = ()=>{ window.focus(); showReceiveModal(challenge) };
    }catch(e){
      alert("New Challenge "+challenge.description);
      showReceiveModal(challenge);
    }
  } else {
    alert("New Challenge "+challenge.description);
    showReceiveModal(challenge);
  }
}
function showReceiveModal(challenge){
  pendingReceived = challenge;
  document.getElementById("receiveDesc").innerText = challenge.description;
  document.getElementById("receivePrize").innerText = challenge.stake || "—";
  document.getElementById("receiveRules").innerText = challenge.rules || "—";
  document.getElementById("receiveSeries").innerText = challenge.series===""?"Single":(challenge.series==="bo3"?"BEST OF 3":"BEST OF 7");
  document.getElementById("receiveModal").classList.add("show");
}
function closeReceiveModal(e){ if(e) e.stopPropagation(); document.getElementById("receiveModal").classList.remove("show") }
function acceptChallenge(){
  if(pendingReceived){
    const idx = activeChallenges.findIndex(x=>x.id===pendingReceived.id);
    if(idx>=0){
      activeChallenges[idx].deadline = Date.now() + (activeChallenges[idx].duration*1000);
      activeChallenges[idx].timerStarted = true;
    }else{
      const accepted = Object.assign({}, pendingReceived, {
        deadline: Date.now() + (pendingReceived.duration*1000),
        timerStarted:true
      });
      activeChallenges.push(accepted);
    }
    persist(); renderAll();
  }
  closeReceiveModal();
}
function declineChallenge(){
  if(pendingReceived){
    historyChallenges.push(Object.assign({},pendingReceived,{declined:true}));
    // Also remove any pending copy in active list with same id
    const idx = activeChallenges.findIndex(x=>x.id===pendingReceived.id);
    if(idx>=0) activeChallenges.splice(idx,1);
    persist(); renderAll();
  }
  closeReceiveModal();
}

/* Persistence */
function persist(){
  localStorage.setItem("activeChallenges",JSON.stringify(activeChallenges));
  localStorage.setItem("historyChallenges",JSON.stringify(historyChallenges));
  localStorage.setItem("wins",JSON.stringify(wins));
  localStorage.setItem("proofs",JSON.stringify(proofs));
}

/* Account and avatar */
let state = { user:{name:'',email:'',loggedIn:false,avatar:null} };

function loadUserFromStorage(){
  const saved=localStorage.getItem("decadareUser");
  if(saved){
    state.user=JSON.parse(saved);
    if(state.user.name) document.getElementById("username").value=state.user.name;
    if(state.user.email) document.getElementById("useremail").value=state.user.email;
    if(state.user.avatar) document.getElementById("avatarPreview").src=state.user.avatar;
  }
}
function wireAvatarUpload(){
  const up=document.getElementById("avatarUpload");
  if(up){
    up.addEventListener("change", e=>{
      const file=e.target.files[0];
      if(file){
        const reader=new FileReader();
        reader.onload=()=>{
          document.getElementById("avatarPreview").src=reader.result;
          state.user.avatar = reader.result;
          state.user.loggedIn = true;
          localStorage.setItem("decadareUser", JSON.stringify(state.user));
          updateNavAvatar();
          showToast("Avatar updated");
        };
        reader.readAsDataURL(file);
      }
    });
  }
}
function saveAccount(){
  const name=document.getElementById("username").value;
  const email=document.getElementById("useremail").value;
  const avatar=document.getElementById("avatarPreview").src || null;
  state.user={name,email,loggedIn:true,avatar};
  localStorage.setItem("decadareUser",JSON.stringify(state.user));
  updateNavAvatar();
  showToast("Account saved");
}
function logout(){
  state.user={name:'',email:'',loggedIn:false,avatar:null};
  localStorage.removeItem("decadareUser");
  updateNavAvatar();
  showToast("Logged out");
  navTo('home');
}
function updateNavAvatar(){
  const navAvatar=document.getElementById("navAvatar");
  const accountBtn=document.getElementById("accountBtn");
  const u = state.user;
  if(u && u.avatar){
    if(navAvatar){
      navAvatar.src=u.avatar;
      navAvatar.style.display="inline-block";
      navAvatar.onclick=()=>navTo('account');
    }
    if(accountBtn){ accountBtn.style.display="none" }
  }else{
    if(navAvatar){ navAvatar.style.display="none" }
    if(accountBtn){ accountBtn.style.display="inline-block" }
  }
}

/* Simple toast */
let toastTimer=null;
function showToast(msg){
  let t=document.getElementById("toast");
  if(!t){
    t=document.createElement("div");
    t.id="toast";
    t.style.position="fixed";t.style.bottom="20px";t.style.left="50%";t.style.transform="translateX(-50%)";
    t.style.background="#000";t.style.color="#fff";t.style.padding="10px 14px";t.style.borderRadius="10px";t.style.opacity="0.9";t.style.zIndex="2000";
    document.body.appendChild(t);
  }
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{ t.style.display="none" },1500);
}

/* Tests */
function testWin(){
  const sample={ description:"Sample challenge won", stake:"Dinner for Two", rules:"—", series:"bo3", score:{a:2,b:1} };
  notifyWin(sample);
  showWinsDetail(sample);
}
function testReceived(){
  const sample={ id: "test-"+Date.now(), initiator:"Alex", description:"Cook dinner together", stake:"Loser does dishes", rules:"No takeout", series:"bo3", score:{a:0,b:0}, duration:600 };
  notifyReceived(sample);
}

/* Init */
renderAll();
</script>
</body>
</html>
